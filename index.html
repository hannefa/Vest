<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vest – kart</title>

  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { width: 100%; height: 100vh; }

    /* Popup styling (matcher Fileks uttrykket) */
    .mapboxgl-popup-content {
      background: #ffffff;
      border-radius: 12px;
      padding: 12px 14px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    .popup-title {
      font-size: 15px;
      font-weight: 700;
      color: #6F3A8A;
      line-height: 1.2;
    }
    .popup-sub {
      font-size: 12px;
      color: #6B7280;
      margin-top: 3px;
    }
    .mapboxgl-popup-tip {
      border-top-color: #ffffff !important;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <script>
    // ========= Konfig =========
    mapboxgl.accessToken = "pk.eyJ1IjoiaGFhbm5uZWVlZSIsImEiOiJjbWE0Nnp4OWwwM3NxMmlxejNudXBwa2I3In0.EzmmIDuSMF5JupYeej9NoA";

    // Basemap: bruk Mapbox sin Streets v12 direkte (stabil, ikke "Standard"-issues)
    const STYLE_URL = "mapbox://styles/mapbox/streets-v12";

    // Dine punkter
    const GEOJSON_URL = "./klesbokser_clean_stripped.geojson";

    // Hvis du vet eksakt property i GeoJSON: sett den her (f.eks. "navn")
    const NAME_PROP = null;

    // Vis enkeltpunkter først fra denne zoomen (så cluster ikke blandes med punkter)
    const POINTS_MIN_ZOOM = 14;

    // ========= Liten feilmelding-boks =========
    function showError(msg) {
      let el = document.getElementById("map-error");
      if (!el) {
        el = document.createElement("div");
        el.id = "map-error";
        el.style.cssText = `
          position: fixed; left: 12px; bottom: 12px; z-index: 9999;
          background: rgba(17,24,39,.92); color: #fff; padding: 10px 12px;
          border-radius: 10px; font: 12px/1.4 system-ui, sans-serif; max-width: 520px;
        `;
        document.body.appendChild(el);
      }
      el.textContent = msg;
    }

    // ========= Lag kartet =========
    const map = new mapboxgl.Map({
      container: "map",
      style: STYLE_URL,
      center: [10.75, 59.91],
      zoom: 5
    });

    map.addControl(new mapboxgl.NavigationControl({ showCompass: true }), "top-right");

    // Debug: sjekk at basemap faktisk har lag/sources
    map.on("style.load", () => {
      const s = map.getStyle();
      console.log("STYLE name:", s && s.name);
      console.log("Layers:", s && s.layers ? s.layers.length : 0);
      console.log("Sources:", s && s.sources ? Object.keys(s.sources) : []);
    });

    // Global feilhåndtering
    map.on("error", (e) => {
      const err = e && e.error ? e.error : e;
      console.error("Map error:", err);
      showError("Mapbox-feil: " + (err && err.message ? err.message : String(err)));
    });

// ========= Data + layers =========
map.on("load", () => {
  // Source med clustering
  map.addSource("utplasseringer", {
    type: "geojson",
    data: GEOJSON_URL,
    cluster: true,
    clusterMaxZoom: POINTS_MIN_ZOOM, // cluster slutter ca når punkter begynner
    clusterRadius: 50
  });

  // Auto-zoom til hvor punktene faktisk ligger (men maks "Norge-oversikt")
  fetch(GEOJSON_URL)
    .then((r) => r.json())
    .then((geo) => {
      const b = new mapboxgl.LngLatBounds();

      (geo.features || []).forEach((f) => {
        const c = f?.geometry?.coordinates;
        if (c && Array.isArray(c) && c.length >= 2) b.extend(c);
      });

      if (!b.isEmpty()) {
        map.fitBounds(b, {
          padding: 60,
          // dette setter hvor langt inn den får zoome automatisk
          // lavere = mer "oversiktlig"
          maxZoom: 7,
          duration: 0
        });
      }
    })
    .catch((err) => console.warn("Kunne ikke lese GeoJSON for fitBounds:", err));

  // Cluster-sirkler
  map.addLayer({
    id: "clusters",
    type: "circle",
    source: "utplasseringer",
    filter: ["has", "point_count"],
    paint: {
      "circle-color": [
        "step",
        ["get", "point_count"],
        "#9c6bb3",     // 1–9
        10, "#6F3A8A", // 10–29
        30, "#4B1F66"  // 30+
      ],
      "circle-radius": [
        "step",
        ["get", "point_count"],
        18,
        10, 22,
        30, 28
      ],
      "circle-stroke-width": 0
    }
  });

  // Tall i clusters (uten halo)
  map.addLayer({
    id: "cluster-count",
    type: "symbol",
    source: "utplasseringer",
    filter: ["has", "point_count"],
    layout: {
      "text-field": "{point_count_abbreviated}",
      "text-font": ["DIN Offc Pro Medium", "Arial Unicode MS Bold"],
      "text-size": 13
    },
    paint: {
      "text-color": "#ffffff"
    }
  });

  // Enkeltpunkter (ikke cluster)
  map.addLayer({
    id: "unclustered-point",
    type: "circle",
    source: "utplasseringer",
    filter: ["!", ["has", "point_count"]],
    minzoom: POINTS_MIN_ZOOM,
    paint: {
      "circle-color": "#743492",
      "circle-radius": 6,
      "circle-stroke-color": "#ffffff",
      "circle-stroke-width": 1.5
    }
  });

  // Klikk på cluster -> zoom inn
  map.on("click", "clusters", (e) => {
    const features = map.queryRenderedFeatures(e.point, { layers: ["clusters"] });
    if (!features.length) return;

    const clusterId = features[0].properties.cluster_id;
    const source = map.getSource("utplasseringer");

    source.getClusterExpansionZoom(clusterId, (err, zoom) => {
      if (err) return;
      map.easeTo({ center: features[0].geometry.coordinates, zoom });
    });
  });

  // Cursor for clusters
  map.on("mouseenter", "clusters", () => (map.getCanvas().style.cursor = "pointer"));
  map.on("mouseleave", "clusters", () => (map.getCanvas().style.cursor = ""));

  // Hover popup på enkeltpunkter
  let popup = null;

  function resolveLabel(props) {
    if (!props) return "";
    if (NAME_PROP && props[NAME_PROP] != null) return String(props[NAME_PROP]);

    const candidates = ["navn", "name", "title", "sted", "lokasjon", "adresse", "label"];
    for (const key of candidates) {
      const v = props[key];
      if (v != null && String(v).trim() !== "") return String(v);
    }
    return "";
  }

  map.on("mouseenter", "unclustered-point", (e) => {
    map.getCanvas().style.cursor = "pointer";
    const f = e.features && e.features[0];
    if (!f) return;

    const coords = f.geometry.coordinates.slice();
    const label = resolveLabel(f.properties);

    if (popup) popup.remove();

    popup = new mapboxgl.Popup({ closeButton: false, closeOnClick: false })
      .setLngLat(coords)
      .setHTML(`
        <div class="popup">
          <div class="popup-title">${label || "Ukjent navn"}</div>
          <div class="popup-sub">Fileks-boks</div>
        </div>
      `)
      .addTo(map);
  });

  map.on("mouseleave", "unclustered-point", () => {
    map.getCanvas().style.cursor = "";
    if (popup) popup.remove();
    popup = null;
  });
});
